package wasm96:core@0.1.0;

/// The simplified wasm96 host ABI.
///
/// Design goals:
/// - Intuitive, safe API inspired by Processing, p5.js, and LÃ–VE.
/// - No direct buffer manipulation; Host handles clipping and rendering.
/// - Stateless immediate mode drawing.
world wasm96 {
  // =========================
  // Guest Exports
  // =========================

  /// Called once on startup. Initialize state and register screen size here.
  export setup: func();

  /// Called once per frame. Update game logic here.
  export update: func();

  /// Called once per frame after update. Draw to the screen here.
  export draw: func();

  // =========================
  // Host Imports
  // =========================

  import graphics: interface {
    /// Register screen dimensions.
    /// Should be called during `setup`.
    set-size: func(width: u32, height: u32);

    /// Set the current drawing color (RGBA).
    /// Affects subsequent drawing commands.
    set-color: func(r: u8, g: u8, b: u8, a: u8);

    /// Clear the screen with a specific color (RGB).
    /// Alpha is assumed 255.
    background: func(r: u8, g: u8, b: u8);

    /// Draw a single pixel at (x, y) with the current color.
    point: func(x: s32, y: s32);

    /// Draw a line from (x1, y1) to (x2, y2) with the current color.
    line: func(x1: s32, y1: s32, x2: s32, y2: s32);

    /// Draw a filled rectangle at (x, y) with size (w, h) using the current color.
    rect: func(x: s32, y: s32, w: u32, h: u32);

    /// Draw a rectangle outline at (x, y) with size (w, h) using the current color.
    rect-outline: func(x: s32, y: s32, w: u32, h: u32);

    /// Draw a filled circle at (x, y) with radius r using the current color.
    circle: func(x: s32, y: s32, r: u32);

    /// Draw a circle outline at (x, y) with radius r using the current color.
    circle-outline: func(x: s32, y: s32, r: u32);

    /// Draw an image/sprite at (x, y).
    /// `data` is a sequence of RGBA bytes (4 bytes per pixel).
    /// The host handles clipping and bounds checking.
    image: func(x: s32, y: s32, w: u32, h: u32, data: list<u8>);

    /// Draw an image from raw PNG bytes at (x, y).
    image-png: func(x: s32, y: s32, data: list<u8>);

    /// Register an SVG resource under a guest-provided string key.
    ///
    /// The host keeps the decoded representation, and the guest can reference it by key.
    /// Returns true on success.
    svg-register: func(key: u64, data: list<u8>) -> bool;

    /// Draw the SVG resource identified by `key` at (x,y) scaled to (w,h).
    svg-draw: func(key: u64, x: s32, y: s32, w: u32, h: u32);

    /// Unregister an SVG resource by key.
    svg-unregister: func(key: u64);

    /// Register a GIF resource under a guest-provided string key.
    ///
    /// The host keeps the decoded frames, and the guest can reference it by key.
    /// Returns true on success.
    gif-register: func(key: u64, data: list<u8>) -> bool;

    /// Draw the GIF identified by `key` at (x,y) at its natural size, animating based on time.
    gif-draw: func(key: u64, x: s32, y: s32);

    /// Draw the GIF identified by `key` at (x,y) scaled to (w,h), animating based on time.
    gif-draw-scaled: func(key: u64, x: s32, y: s32, w: u32, h: u32);

    /// Unregister a GIF resource by key.
    gif-unregister: func(key: u64);

    /// Register a PNG resource under a guest-provided string key.
    ///
    /// The host decodes the PNG and stores it as RGBA for later drawing.
    /// Returns true on success.
    png-register: func(key: u64, data: list<u8>) -> bool;

    /// Draw the PNG identified by `key` at (x,y) at its natural size.
    png-draw: func(key: u64, x: s32, y: s32);

    /// Draw the PNG identified by `key` at (x,y) scaled to (w,h).
    png-draw-scaled: func(key: u64, x: s32, y: s32, w: u32, h: u32);

    /// Unregister a PNG resource by key.
    png-unregister: func(key: u64);

    /// Register a TrueType (TTF) font under a guest-provided string key.
    ///
    /// Returns true on success.
    font-register-ttf: func(key: u64, data: list<u8>) -> bool;

    /// Register a built-in Spleen bitmap font under the provided key at the specified size.
    ///
    /// The canonical key for the built-in font family is `"spleen"`.
    /// Returns true on success.
    font-register-spleen: func(key: u64, size: u32) -> bool;

    /// Unregister a font by key.
    font-unregister: func(key: u64);

    /// Draw text at (x,y) using the font identified by `font-key` and the current color.
    text: func(x: s32, y: s32, font-key: u64, text: string);

    /// Measure the width and height of the text using the font identified by `font-key`.
    /// Returns (width, height).
    text-measure: func(font-key: u64, text: string) -> tuple<u32, u32>;

    /// Draw a filled triangle with vertices (x1,y1), (x2,y2), (x3,y3) using the current color.
    triangle: func(x1: s32, y1: s32, x2: s32, y2: s32, x3: s32, y3: s32);

    /// Draw a triangle outline with vertices (x1,y1), (x2,y2), (x3,y3) using the current color.
    triangle-outline: func(x1: s32, y1: s32, x2: s32, y2: s32, x3: s32, y3: s32);

    /// Draw a quadratic Bezier curve from (x1,y1) to (x2,y2) with control point (cx,cy), tessellated into `segments` lines.
    bezier-quadratic: func(x1: s32, y1: s32, cx: s32, cy: s32, x2: s32, y2: s32, segments: u32);

    /// Draw a cubic Bezier curve from (x1,y1) to (x2,y2) with control points (cx1,cy1) and (cx2,cy2), tessellated into `segments` lines.
    bezier-cubic: func(x1: s32, y1: s32, cx1: s32, cy1: s32, cx2: s32, cy2: s32, x2: s32, y2: s32, segments: u32);

    /// Draw a filled pill (rounded rectangle) at (x,y) with size (w,h) using the current color.
    pill: func(x: s32, y: s32, w: u32, h: u32);

    /// Draw a pill outline at (x,y) with size (w,h) using the current color.
    pill-outline: func(x: s32, y: s32, w: u32, h: u32);
  }

  import input: interface {
    enum button {
      b, y, select, start,
      up, down, left, right,
      a, x, l1, r1, l2, r2, l3, r3
    }

    /// Returns true if the specified button is currently held down.
    is-button-down: func(port: u32, btn: button) -> bool;

    /// Returns true if the specified key is currently held down.
    /// Key codes are implementation defined (e.g. USB HID or libretro key constants).
    is-key-down: func(key: u32) -> bool;

    /// Get current mouse X position.
    get-mouse-x: func() -> s32;

    /// Get current mouse Y position.
    get-mouse-y: func() -> s32;

    /// Returns true if the specified mouse button is held down.
    /// 0 = Left, 1 = Right, 2 = Middle.
    is-mouse-down: func(button: u32) -> bool;
  }

  import audio: interface {
    /// Initialize audio system.
    /// Returns the buffer size (in samples) that the host expects per frame.
    init: func(sample-rate: u32) -> u32;

    /// Push a chunk of audio samples.
    /// Samples are interleaved stereo (L, R, L, R...) signed 16-bit integers.
    /// This should be called once per frame in `update` or `draw`.
    push-samples: func(samples: list<s16>);

    /// Play a WAV file.
    /// The WAV data is decoded and played as a one-shot audio channel.
    play-wav: func(data: list<u8>);

    /// Play a QOA file.
    /// The QOA data is decoded and played as a looping audio channel.
    play-qoa: func(data: list<u8>);

    /// Play an XM file.
    /// The XM data is decoded using xmrsplayer and played as a looping audio channel.
    play-xm: func(data: list<u8>);
  }

  import storage: interface {
    /// Save data associated with a key.
    save: func(key: string, data: list<u8>);

    /// Load data associated with a key.
    load: func(key: string) -> list<u8>;
  }

  import system: interface {
    /// Log a message to the host console.
    log: func(message: string);

    /// Get the number of milliseconds since the app started.
    millis: func() -> u64;
  }
}
